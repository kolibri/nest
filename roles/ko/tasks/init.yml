---
- block:
    - name: update apt
      apt: update_cache=yes
      when: ansible_pkg_mgr == "apt"
    
    - name: update pacman
      pacman:
        update_cache: yes
        upgrade: yes
      when: ansible_pkg_mgr == "pacman"

    - name: install init packages with pacman
      pacman:
        name: "{{ item }} "
        state: present
      when: ansible_pkg_mgr == "pacman"
      with_items:
        - base-devel
        - dialog
        - sudo
        - python2
        - wget
        - dosfstools # @todo: perhaps move this out

    - name: disable root login
      lineinfile:
        dest: /etc/ssh/sshd_config
        line: PermitRootLogin no
        regexp: "^PermitRootLogin.*$"
      notify:
        - restart ssh

    - name: ensure ssh is running (and enabled)
      service:
        name: "{{ ssh_service_name }}"
        enabled: yes
      notify:
        - restart ssh

    - name: set hostname
      hostname:
        name: "{{ ko_hostname }}"
  become: true

- block:
    - name: ensure ko group
      group:
        name: "{{ ko_user_group }}"
        state: present

    - name: ensure ko user
      user:
        name: "{{ ko_user_name }}"
        groups: "{{ ko_user_group }}"
        append: yes
        generate_ssh_key: yes
        password: "{{ ko_user_pass }}"

    - name: ensure root privileges for ko user
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: "^{{ ko_user_name }} ALL"
        line: "{{ ko_user_name }} ALL=(ALL) NOPASSWD:ALL"
        validate: "visudo -cf %s"

    - name: add authorized key of controll machine 
      authorized_key:
        user: "{{ ko_user_name }}"
        key: "{{ lookup('file', ko_authorized_key_file) }}"
      when: ansible_connection != local
    
  when: ko_user_configure
  become: true
